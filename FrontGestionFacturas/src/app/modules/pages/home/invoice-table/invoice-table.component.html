<h1 mat-dialog-title>{{data.invoice.name}}</h1>
<div mat-dialog-content>
    <mat-card>
        <form class="example-container" [formGroup]="rowForm" (submit)="createRow()">
            <mat-form-field appearance="fill">
                <mat-label>Descripción</mat-label>
                <input matInput type="text" formControlName="item" maxlength="50">
            </mat-form-field>
            <mat-form-field appearance="fill" class="small-input">
                <mat-label>Cantidad</mat-label>
                <input matInput type="number" formControlName="quantity" min="1">
            </mat-form-field>
            <mat-form-field appearance="fill" class="medium-input">
                <mat-label>Valor</mat-label>
                <input matInput type="number" formControlName="itemValue" min="0">
            </mat-form-field>
    
            <button type="submit" mat-raised-button color="primary" [disabled]="rowForm.invalid">
                ADD ROW
            </button>
        </form>
    </mat-card>

    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8 invoice-table">

        <!-- Columnas editables de la factura -->
        <ng-container [matColumnDef]="col.key" *ngFor="let col of columnsSchema">
            <th mat-header-cell *matHeaderCellDef>
                {{ col.label }}
            </th>
            <td mat-cell *matCellDef="let element">
                <!-- Si la fila no está en modo de edición se muestran sus valores-->
                <div *ngIf="!element.isEdit">
                    {{ ((col.key === 'itemValue')? (element[col.key] | currency): element[col.key]) }}
                </div>
                <!-- De no ser así,  se muestran campos editables -->
                <div *ngIf="element.isEdit">
                    <mat-form-field [class]="getClass(col.key)">
                        <input [type]="col.type" matInput [(ngModel)]="element[col.key]" />
                    </mat-form-field>
                </div>
            </td>
        </ng-container>

        <!-- Columna de importe total -->
        <ng-container matColumnDef="invoice-totalAmount">
            <th mat-header-cell *matHeaderCellDef> Subtotal </th>
            <td mat-cell *matCellDef="let element"> {{element.quantity * element.itemValue | currency}}</td>
        </ng-container>

        <!-- Columna de acciones para la fila -->
        <ng-container matColumnDef="invoice-actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let element">
                <!-- Acción para indicar que la edición se ha completado -->
                <div class="btn-edit" *ngIf="element.isEdit; else dataField">
                    <button mat-mini-fab color="accent" (click)="element.isEdit = !element.isEdit; editedRow(element)">
                        <mat-icon>done</mat-icon>
                    </button>
                    <button mat-mini-fab color="accent" (click)="element.isEdit = !element.isEdit; editStop(element)">
                        <mat-icon>cancel</mat-icon>
                    </button>
                </div>
                <!-- Acciones disponibles para la fila -->
                <ng-template #dataField>
                    <button mat-mini-fab color="accent" (click)="element.isEdit = !element.isEdit; editStart(element)">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-mini-fab color="warn" (click)="deleteRow(element)">
                        <mat-icon>delete_forever</mat-icon>
                    </button>
                </ng-template>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

    </table>

    <table style="float:right;">
        <tbody>
            <tr>
                <td colspan="2"></td>
                <td>Subtotal</td>
                <td>{{data.total}}</td>
            </tr>
            <tr>
                <td colspan="2"></td>
                <td>Tax {{data.invoice.taxPercentage}}%</td>
                <td>{{data.total * data.invoice.taxPercentage/100 | currency}}</td>
            </tr>
            <tr>
                <td colspan="2"></td>
                <td>TOTAL</td>
                <td>{{data.total * (1 + data.invoice.taxPercentage/100) | currency}}</td>
            </tr>
        </tbody>
    </table>
</div>